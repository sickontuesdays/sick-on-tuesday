<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Test All Iteration Fixes</title>
  <style>
    body {
      font-family: monospace;
      background: #0a0e13;
      color: #e7eefc;
      padding: 20px;
      line-height: 1.6;
    }
    .test-result {
      background: #0f1520;
      border: 1px solid #1f2b3e;
      border-radius: 8px;
      padding: 16px;
      margin: 8px 0;
    }
    .pass { border-color: #34d399; }
    .fail { border-color: #f87171; }
    .summary {
      background: #0f1520;
      border: 2px solid #7dd3fc;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    .function-group {
      background: #121a28;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }
    h2, h3 { color: #7dd3fc; }
    .error-details {
      background: #450a0a;
      padding: 8px;
      border-radius: 4px;
      margin-top: 8px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>üß™ Testing All Array Method Iteration Fixes</h1>
  <div id="test-results"></div>

  <script type="module">
    import { ComprehensiveSynergyEngine } from './js/core/comprehensive-synergy-engine.js';

    const resultsContainer = document.getElementById('test-results');
    let testsPassed = 0;
    let testsFailed = 0;
    let functionTestResults = {};

    function addTestResult(functionName, testName, passed, message, errorDetails = null) {
      if (!functionTestResults[functionName]) {
        functionTestResults[functionName] = { passed: 0, failed: 0, tests: [] };
      }

      const testResult = {
        name: testName,
        passed,
        message,
        errorDetails
      };

      functionTestResults[functionName].tests.push(testResult);

      if (passed) {
        testsPassed++;
        functionTestResults[functionName].passed++;
      } else {
        testsFailed++;
        functionTestResults[functionName].failed++;
      }
    }

    function renderResults() {
      resultsContainer.innerHTML = '';

      // Render function groups
      for (const [functionName, results] of Object.entries(functionTestResults)) {
        const functionDiv = document.createElement('div');
        functionDiv.className = 'function-group';

        const allPassed = results.failed === 0;
        const statusIcon = allPassed ? '‚úÖ' : '‚ùå';

        functionDiv.innerHTML = `
          <h3>${statusIcon} ${functionName}</h3>
          <p>Tests: ${results.passed + results.failed} | Passed: ${results.passed} | Failed: ${results.failed}</p>
        `;

        // Add individual test results
        for (const test of results.tests) {
          const testDiv = document.createElement('div');
          testDiv.className = `test-result ${test.passed ? 'pass' : 'fail'}`;
          testDiv.innerHTML = `
            <strong>${test.passed ? '‚úÖ' : '‚ùå'} ${test.name}</strong><br>
            ${test.message}
            ${test.errorDetails ? `<div class="error-details">${test.errorDetails}</div>` : ''}
          `;
          functionDiv.appendChild(testDiv);
        }

        resultsContainer.appendChild(functionDiv);
      }

      // Add summary
      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'summary';
      const successRate = ((testsPassed / (testsPassed + testsFailed)) * 100).toFixed(1);

      summaryDiv.innerHTML = `
        <h2>üìä Test Summary</h2>
        <strong>Total Functions Tested: ${Object.keys(functionTestResults).length}</strong><br>
        <strong>Total Tests: ${testsPassed + testsFailed}</strong><br>
        ‚úÖ Passed: ${testsPassed}<br>
        ‚ùå Failed: ${testsFailed}<br>
        üìà Success Rate: ${successRate}%<br>
        <br>
        ${testsFailed === 0
          ? '<strong style="color: #34d399;">üéâ All iteration fixes working perfectly!</strong>'
          : '<strong style="color: #f87171;">‚ö†Ô∏è Some fixes still need work</strong>'}
      `;
      resultsContainer.appendChild(summaryDiv);
    }

    try {
      const engine = new ComprehensiveSynergyEngine();

      // Create realistic test data that matches what the actual system produces
      const categorizedModData = {
        general: [
          { name: 'Fastball', key: 'fastball', effects: ['grenade_throw_speed'] },
          { name: 'Momentum Transfer', key: 'momentum_transfer', effects: ['melee_damage_grants_grenade_energy'] }
        ],
        combat: [
          { name: 'Auto Rifle Loader', key: 'auto_rifle_loader', effects: ['reload_speed'] }
        ],
        elementalWells: [
          { name: 'Font of Might', key: 'font_of_might', element: 'solar', effects: ['weapon_damage_bonus'] }
        ],
        chargedWithLight: [
          { name: 'Taking Charge', key: 'taking_charge', effects: ['orbs_grant_charged_with_light'] },
          { name: 'High-Energy Fire', key: 'high_energy_fire', effects: ['weapon_damage_when_charged'] }
        ],
        stats: [],
        artifact: []
      };

      const categorizedExoticData = {
        weapons: [
          { name: 'Gjallarhorn', type: 'weapon', slot: 'power' },
          { name: 'Divinity', type: 'weapon', slot: 'energy' }
        ],
        armor: [
          { name: 'Helm of Saint-14', type: 'armor', slot: 'helmet' }
        ],
        totalRecommendations: [
          { name: 'Witherhoard', type: 'weapon', slot: 'kinetic' }
        ]
      };

      const categorizedAbilityData = {
        super: { name: 'Ward of Dawn', key: 'ward_of_dawn' },
        aspects: [{ name: 'Offensive Bulwark', key: 'offensive_bulwark' }],
        fragments: [{ name: 'Echo of Persistence', key: 'echo_of_persistence' }]
      };

      const buildData = {
        mods: categorizedModData,
        exotics: categorizedExoticData,
        abilities: categorizedAbilityData
      };

      // Test 1: countMatchingMods (previously fixed)
      console.log('Testing countMatchingMods...');
      try {
        let result = engine.countMatchingMods(['fastball'], categorizedModData);
        addTestResult('countMatchingMods', 'Categorized object with fastball', result === 1, `Expected 1, got ${result}`);

        result = engine.countMatchingMods(['nonexistent'], categorizedModData);
        addTestResult('countMatchingMods', 'Categorized object with nonexistent mod', result === 0, `Expected 0, got ${result}`);

        result = engine.countMatchingMods(['fastball'], null);
        addTestResult('countMatchingMods', 'Null data', result === 0, `Expected 0, got ${result}`);
      } catch (error) {
        addTestResult('countMatchingMods', 'Error handling', false, 'Function threw error', error.message);
      }

      // Test 2: countMatchingExotics (previously fixed)
      console.log('Testing countMatchingExotics...');
      try {
        let result = engine.countMatchingExotics(['gjallarhorn'], categorizedExoticData);
        addTestResult('countMatchingExotics', 'Categorized object with gjallarhorn', result === 1, `Expected 1, got ${result}`);

        result = engine.countMatchingExotics(['helm'], categorizedExoticData);
        addTestResult('countMatchingExotics', 'Categorized object with helm (partial match)', result === 1, `Expected 1, got ${result}`);

        result = engine.countMatchingExotics(['nonexistent'], categorizedExoticData);
        addTestResult('countMatchingExotics', 'Categorized object with nonexistent exotic', result === 0, `Expected 0, got ${result}`);
      } catch (error) {
        addTestResult('countMatchingExotics', 'Error handling', false, 'Function threw error', error.message);
      }

      // Test 3: countMatchingAbilities (previously fixed)
      console.log('Testing countMatchingAbilities...');
      try {
        let result = engine.countMatchingAbilities(['ward'], categorizedAbilityData);
        addTestResult('countMatchingAbilities', 'Categorized object with ward (partial match)', result === 1, `Expected 1, got ${result}`);

        result = engine.countMatchingAbilities(['nonexistent'], categorizedAbilityData);
        addTestResult('countMatchingAbilities', 'Categorized object with nonexistent ability', result === 0, `Expected 0, got ${result}`);
      } catch (error) {
        addTestResult('countMatchingAbilities', 'Error handling', false, 'Function threw error', error.message);
      }

      // Test 4: findModSystemConflicts (newly fixed)
      console.log('Testing findModSystemConflicts...');
      try {
        let result = engine.findModSystemConflicts(categorizedModData);
        addTestResult('findModSystemConflicts', 'Categorized mod data', Array.isArray(result), `Expected array, got ${typeof result}`);

        result = engine.findModSystemConflicts([]);
        addTestResult('findModSystemConflicts', 'Empty array', Array.isArray(result), `Expected array, got ${typeof result}`);

        result = engine.findModSystemConflicts(null);
        addTestResult('findModSystemConflicts', 'Null data', Array.isArray(result), `Expected array, got ${typeof result}`);
      } catch (error) {
        addTestResult('findModSystemConflicts', 'Error handling', false, 'Function threw error', error.message);
      }

      // Test 5: findElementalMods (newly fixed)
      console.log('Testing findElementalMods...');
      try {
        let result = engine.findElementalMods(categorizedModData, 'solar');
        addTestResult('findElementalMods', 'Categorized mod data with solar', Array.isArray(result), `Expected array, got ${typeof result}`);

        result = engine.findElementalMods(categorizedModData, 'void');
        addTestResult('findElementalMods', 'Categorized mod data with void', Array.isArray(result), `Expected array, got ${typeof result}`);

        result = engine.findElementalMods(null, 'solar');
        addTestResult('findElementalMods', 'Null data', Array.isArray(result) && result.length === 0, `Expected empty array, got ${result}`);
      } catch (error) {
        addTestResult('findElementalMods', 'Error handling', false, 'Function threw error', error.message);
      }

      // Test 6: calculateModSystemAlignment (newly fixed)
      console.log('Testing calculateModSystemAlignment...');
      try {
        let result = engine.calculateModSystemAlignment(categorizedModData, ['charged_with_light']);
        addTestResult('calculateModSystemAlignment', 'Categorized mod data with CwL system', typeof result === 'number', `Expected number, got ${typeof result}`);

        result = engine.calculateModSystemAlignment([], ['charged_with_light']);
        addTestResult('calculateModSystemAlignment', 'Empty array', typeof result === 'number', `Expected number, got ${typeof result}`);
      } catch (error) {
        addTestResult('calculateModSystemAlignment', 'Error handling', false, 'Function threw error', error.message);
      }

      // Test 7: findExoticConflicts (newly fixed)
      console.log('Testing findExoticConflicts...');
      try {
        let result = engine.findExoticConflicts(categorizedExoticData);
        addTestResult('findExoticConflicts', 'Categorized exotic data', Array.isArray(result), `Expected array, got ${typeof result}`);

        result = engine.findExoticConflicts([]);
        addTestResult('findExoticConflicts', 'Empty array', Array.isArray(result), `Expected array, got ${typeof result}`);

        result = engine.findExoticConflicts(null);
        addTestResult('findExoticConflicts', 'Null data', Array.isArray(result), `Expected array, got ${typeof result}`);
      } catch (error) {
        addTestResult('findExoticConflicts', 'Error handling', false, 'Function threw error', error.message);
      }

      // Test 8: extractBuildTriggers (previously fixed)
      console.log('Testing extractBuildTriggers...');
      try {
        let result = engine.extractBuildTriggers(buildData);
        addTestResult('extractBuildTriggers', 'Complete build data', typeof result === 'object' && result !== null, `Expected object, got ${typeof result}`);

        result = engine.extractBuildTriggers({ mods: [] });
        addTestResult('extractBuildTriggers', 'Empty mod array', typeof result === 'object', `Expected object, got ${typeof result}`);

        result = engine.extractBuildTriggers({});
        addTestResult('extractBuildTriggers', 'Empty build data', typeof result === 'object', `Expected object, got ${typeof result}`);
      } catch (error) {
        addTestResult('extractBuildTriggers', 'Error handling', false, 'Function threw error', error.message);
      }

      // Test 9: safeGetAllItems helper function
      console.log('Testing safeGetAllItems helper...');
      try {
        let result = engine.safeGetAllItems(categorizedModData, ['general', 'combat']);
        addTestResult('safeGetAllItems', 'Categorized object with specific categories', Array.isArray(result) && result.length === 3, `Expected array with 3 items, got ${result.length}`);

        result = engine.safeGetAllItems([1, 2, 3], []);
        addTestResult('safeGetAllItems', 'Already an array', Array.isArray(result) && result.length === 3, `Expected array with 3 items, got ${result.length}`);

        result = engine.safeGetAllItems(null, []);
        addTestResult('safeGetAllItems', 'Null data', Array.isArray(result) && result.length === 0, `Expected empty array, got ${result}`);

        result = engine.safeGetAllItems('invalid', []);
        addTestResult('safeGetAllItems', 'Invalid data type', Array.isArray(result) && result.length === 0, `Expected empty array, got ${result}`);
      } catch (error) {
        addTestResult('safeGetAllItems', 'Error handling', false, 'Function threw error', error.message);
      }

      console.log(`Tests completed: ${testsPassed} passed, ${testsFailed} failed`);

    } catch (error) {
      console.error('Failed to load modules:', error);

      const errorDiv = document.createElement('div');
      errorDiv.className = 'test-result fail';
      errorDiv.innerHTML = `
        <h3>üö® Module Loading Error</h3>
        <pre>${error.message}</pre>
        <div class="error-details">${error.stack}</div>
      `;
      resultsContainer.appendChild(errorDiv);
    }

    // Render results after all tests
    setTimeout(renderResults, 100);
  </script>
</body>
</html>